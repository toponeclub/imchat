<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImChat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* ’á’°’ø ’Ñ’∏÷Ç’£ ’ñ’∏’∂ ÷á ’ñ’∏’∂’ø */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #040816; 
            color: #EAEAEA;
        }

        /* ‘ø’•’∂’ø÷Ä’∏’∂’°’Ø’°’∂ ’ä’°’ø’∏÷Ç’∞’°’∂ */
        .app-window {
            background-color: #101525; 
            border-radius: 18px; 
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
            width: 95%;
            max-width: 1200px; 
            height: 90vh;
            min-height: 600px;
            overflow: hidden;
            display: flex;
        }

        /* ’Ñ’∏÷Ç’ø÷Ñ’°’µ’´’∂ ’ä’°’ø’∏÷Ç’∞’°’∂’∂’•÷Ä’´ ÷á ‘≤’°’¨’∏’∂’∂’•÷Ä’´ ‘≥’∏÷Ç’µ’∂’•÷Ä’® */
        .message-local { background-color: #007AFF; } 
        .message-remote { background-color: #2D3340; } 
        .sidebar { background-color: #0F1321; } 
        .input-bg { background-color: #1C243B; }
        .accent-color { color: #007AFF; }
        .accent-bg { background-color: #007AFF; }
        
        /* ’á’°÷Ä’™’°’Ø’°’∂ ‘¥’´’¶’°’µ’∂’´ ’Ä’°’¥’°÷Ä (’Å’°’≠ ’æ’°’∞’°’∂’°’Ø’® ’©’°÷Ñ’∂’æ’∏÷Ç’¥ ’ß ÷É’∏÷Ñ÷Ä ’ß’Ø÷Ä’°’∂’∂’•÷Ä’´’∂) */
        @media (max-width: 768px) {
            .app-window { flex-direction: column; }
            .sidebar { width: 100%; height: 100%; border-right: none; }
            .chat-area { width: 100%; height: 100%; }
            #users-panel.active { display: flex; }
            #users-panel.inactive { display: none; }
            #chat-area-main.active { display: flex; }
            #chat-area-main.inactive { display: none; }
        }
        
        /* ’ç÷Ñ÷Ä’∏’¨’¢’°÷Ä’•÷Ä’´ ’Ñ’´’∂’´’¥’°’¨ ’à’≥ */
        #chat-container::-webkit-scrollbar, #users-list::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-thumb, #users-list::-webkit-scrollbar-thumb { background: #383838; border-radius: 3px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- ’ä÷Ä’∏÷Ü’´’¨’´ ‘ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä’´ ’Ñ’∏’§’°’¨ -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-[#101525] p-6 rounded-xl shadow-2xl w-full max-w-md border border-[#1C243B]">
            <h3 class="text-xl font-bold mb-4 text-white">’ä÷Ä’∏÷Ü’´’¨’´ ‘ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥’∂’•÷Ä</h3>
            
            <div class="flex flex-col items-center mb-6">
                <img id="profile-avatar-display" src="https://placehold.co/100x100/3B82F6/FFFFFF?text=A" class="w-24 h-24 rounded-full mb-3 object-cover border-4 border-blue-500">
                <p id="profile-user-id" class="text-xs font-mono text-gray-400 break-all mb-2"></p>
                <input type="file" id="avatar-input" accept="image/*" class="text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer">
            </div>

            <div class="mb-4">
                <label for="display-name-input" class="block text-sm font-medium text-gray-300 mb-1">’ë’∏÷Ç÷Å’°’§÷Ä’æ’∏’≤ ‘±’∂’∏÷Ç’∂</label>
                <input type="text" id="display-name-input" placeholder="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’Å’•÷Ä ’°’∂’∏÷Ç’∂’®"
                       class="w-full p-2 rounded-lg input-bg border border-[#1C243B] text-white focus:ring-1 focus:ring-blue-500">
            </div>

            <div class="mb-6 text-sm">
                 <p class="text-gray-300 font-bold mb-2">’Ä’°’æ’•’¨’æ’°’Æ’´ ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø</p>
                 <p class="text-gray-400">‚úÖ ‘æ’°’∂’∏÷Ç÷Å’∏÷Ç’¥’∂’•÷Ä. <span id="notif-status">‘±’∂’ª’°’ø’æ’°’Æ</span></p>
                 <p class="text-gray-400">üé§ ’Ñ’´’Ø÷Ä’∏÷Ü’∏’∂. <span id="mic-status">‘±’∂’∞’°’Ω’°’∂’•’¨’´</span></p>
            </div>


            <div class="flex justify-end space-x-3">
                <button onclick="closeProfileModal()" class="py-2 px-4 rounded-lg text-gray-300 hover:bg-[#1C243B] transition">
                    ’ì’°’Ø’•’¨
                </button>
                <button onclick="saveProfileChanges()" class="py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition">
                    ’ä’°’∞’∫’°’∂’•’¨
                </button>
            </div>
        </div>
    </div>


    <!-- ’Ä’´’¥’∂’°’Ø’°’∂ APP ’ä’°’ø’∏÷Ç’∞’°’∂ -->
    <div class="app-window">

        <!-- ’Å’°’≠ ’Ø’∏’≤’¥. ’ï’£’ø’°’ø’•÷Ä’•÷Ä ÷á ’Ü’°’æ’´’£’°÷Å’´’° -->
        <div id="users-panel" class="sidebar md:w-1/3 max-w-sm flex flex-col inactive md:active">
            
            <!-- ‘≥’¨’≠’°’¥’°’Ω (’Ñ’´’∂’´’¥’°’¨) -->
            <div class="p-3 border-b border-[#1C243B] flex items-center justify-between">
                <h2 class="text-sm font-semibold text-gray-300">‘∂÷Ä’∏÷Ç’µ÷Å’∂’•÷Ä</h2>
                <!-- ’ì’∏÷Ñ÷Ä ’ß’Ø÷Ä’°’∂’∂’•÷Ä’´ ’æ÷Ä’° ’â’°’©’´ ’Ø’∏’≥’°’Ø -->
                <button id="show-chat-btn" onclick="toggleView('chat')" class="md:hidden text-gray-400 hover:text-blue-400 transition">
                    <i class="fas fa-arrow-right"></i> ’â’°’©
                </button>
            </div>
            
            <!-- ’ä÷Ä’∏÷Ü’´’¨’´ ’è’°÷Ä’°’Æ÷Ñ -->
             <div class="p-3 border-b border-[#1C243B]">
                <div class="flex items-center justify-between cursor-pointer hover:bg-[#1C243B] p-2 -m-2 rounded-lg transition" onclick="openProfileModal()">
                    <div class="flex items-center gap-3">
                         <img id="sidebar-avatar" src="https://placehold.co/32x32/3B82F6/FFFFFF?text=A" class="w-8 h-8 rounded-full object-cover">
                         <p id="sidebar-display-name" class="font-semibold text-sm">’Ñ’´’°÷Å’∏÷Ç’¥...</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-500 text-xs"></i>
                </div>
            </div>

            <!-- ’ï’£’ø’°’ø’•÷Ä’•÷Ä’´ ’ë’∏÷Ç÷Å’°’Ø -->
            <ul id="users-list" class="flex-grow overflow-y-auto px-3 py-3 space-y-1">
                <!-- ’ï’£’ø’°’ø’•÷Ä’•÷Ä’® ’Ø’°’æ’•’¨’°’∂’°’∂ ’°’µ’Ω’ø’•’≤ -->
            </ul>
            
            <!-- ’Ü’∏÷Ä ’ï’£’ø’°’ø’•÷Ä ‘±’æ’•’¨’°÷Å’∂’•’¨’∏÷Ç ‘≤’°’™’´’∂ -->
            <div class="p-3 border-t border-[#1C243B]">
                <div class="flex gap-2">
                    <input type="text" id="add-user-input" placeholder="‘±’æ’•’¨’°÷Å’∂’•’¨ ID-’∂..."
                           class="flex-grow p-2 text-sm rounded-lg input-bg border border-transparent text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <button onclick="addUser()" class="py-2 px-3 text-sm bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition duration-150">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ‘±’ª ’Ø’∏’≤’¥. ’â’°’©’´ ’ä’°’ø’∏÷Ç’∞’°’∂ ÷á ’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’∏÷Ç’¥ -->
        <div id="chat-area-main" class="flex-grow flex flex-col bg-[#0A0D1A] inactive md:active">
            <!-- ‘∏’∂’©’°÷Å’´’Ø ‘∂÷Ä’∏÷Ç÷Å’°’Ø÷Å’´ ‘≥’¨’≠’°’¥’°’Ω -->
            <div id="chat-header" class="p-4 border-b border-[#1C243B] h-[60px] flex items-center justify-between">
                <!-- ’ì’∏÷Ñ÷Ä ’ß’Ø÷Ä’°’∂’∂’•÷Ä’´ ’æ÷Ä’° ’ë’∏÷Ç÷Å’°’Ø’´ ’Ø’∏’≥’°’Ø -->
                <button id="show-list-btn" onclick="toggleView('list')" class="md:hidden text-gray-400 hover:text-blue-400 transition mr-3">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3 id="current-chat-name" class="text-lg font-bold text-white">
                    üëã ‘∏’∂’ø÷Ä’•÷Ñ ‘∂÷Ä’∏÷Ç÷Å’°’Ø’´÷Å
                </h3>
            </div>
            
            <!-- ’Ä’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’´ ’ë’∏÷Ç÷Å’°’Ø -->
            <div id="chat-container" class="flex-grow p-6 space-y-4 overflow-y-auto">
                <p id="initial-message" class="text-center text-gray-500 mt-10">
                    ‘∏’∂’ø÷Ä’•÷Ñ ’¶÷Ä’∏÷Ç÷Å’°’Ø’´÷Å ’Å’•÷Ä ÷Å’∏÷Ç÷Å’°’Ø’´÷Å ’Ø’°’¥ ’°’æ’•’¨’°÷Å÷Ä’•÷Ñ ’∂’∏÷Ä’´’∂÷â
                </p>
            </div>

            <!-- ’Ä’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’°’∂ ’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’∏÷Ç’¥ -->
            <div id="input-area" class="p-4 border-t border-[#1C243B] h-[80px]">
                <div class="flex space-x-3 items-center">
                    
                    <!-- ’Å’°’µ’∂’°’£÷Ä’¥’°’∂ ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø / ’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’∏÷Ç’¥ -->
                    <div id="input-wrapper" class="flex-grow flex items-center h-10">
                        <div id="recording-status" class="hidden flex-grow items-center justify-between p-2 rounded-xl input-bg h-full">
                            <span class="text-red-400 font-semibold flex items-center gap-2">
                                 <i class="fas fa-dot-circle animate-pulse"></i> ’Å’°’µ’∂’°’£÷Ä’æ’∏÷Ç’¥ ’ß... <span id="rec-time">0:00</span>
                            </span>
                            <button onclick="stopRecording(false)" class="text-gray-400 hover:text-white" title="’â’•’≤’°÷Ä’Ø’•’¨">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>

                        <input type="text" id="message-input" placeholder="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂..."
                               class="flex-grow p-3 rounded-xl input-bg border border-transparent text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                               onkeypress="if(event.key === 'Enter') sendMessage()" disabled>
                    </div>

                    <!-- ’Å’°’µ’∂’°’£÷Ä’¥’°’∂ ‘ø’∏’≥’°’Ø (‘±’ª ’Ø’∏’≤’¥) -->
                    <button id="mic-button" onclick="toggleRecording()" 
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-600 hover:bg-gray-700 text-white transition disabled:opacity-50" 
                            title="’Å’°’µ’∂’°’µ’´’∂ ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂" disabled>
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <!-- ’à÷Ç’≤’°÷Ä’Ø’•’¨ ‘ø’∏’≥’°’Ø -->
                    <button onclick="sendMessage()" id="send-button"
                            class="w-10 h-10 flex items-center justify-center rounded-full accent-bg hover:bg-blue-700 text-white font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase ÷á ‘≥’∏÷Ä’Æ’°’º’∏÷Ç’µ’©’∂’•÷Ä’´ ’ç’Ø÷Ä’´’∫’ø -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ‘≥’¨’∏’¢’°’¨ ’ì’∏÷É’∏’≠’°’Ø’°’∂’∂’•÷Ä
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, currentUserId = null;
        let unsubscribeMessages = null; 
        let activeRecipientId = null; 
        let userList = []; 
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingStartTime = 0;
        
        // ’ï’£’ø’°’ø’´÷Ä’∏’ª ’ä÷Ä’∏÷Ü’´’¨’´ ’è’æ’µ’°’¨’∂’•÷Ä’®
        let userProfile = {
            displayName: 'Guest',
            avatarUrl: null // Base64 image data
        };

        // UI ‘∑’¨’•’¥’•’∂’ø’∂’•÷Ä
        const usersListEl = document.getElementById('users-list');
        const chatContainer = document.getElementById('chat-container');
        const currentChatNameEl = document.getElementById('current-chat-name');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');
        const recordingStatusEl = document.getElementById('recording-status');
        const recTimeEl = document.getElementById('rec-time');
        const profileModalEl = document.getElementById('profile-modal');
        const profileUserIdEl = document.getElementById('profile-user-id');
        const displayNameInput = document.getElementById('display-name-input');
        const avatarInput = document.getElementById('avatar-input');
        const sidebarDisplayNameEl = document.getElementById('sidebar-display-name');
        const sidebarAvatarEl = document.getElementById('sidebar-avatar');
        const profileAvatarDisplayEl = document.getElementById('profile-avatar-display');
        const notifStatusEl = document.getElementById('notif-status');
        const micStatusEl = document.getElementById('mic-status');

        setLogLevel('Debug');

        // --- 1. Core Functions (Firebase, Auth, Data) ---
        async function initializeFirebase() {
            if (!firebaseConfig) return;

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        loadProfile();
                        loadFriends();
                        checkMediaPermissions(); 
                        requestNotificationPermission(); 
                    } else {
                        currentUserId = null;
                        renderUsersList(); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
        
        function getChatId(user1, user2) {
            return user1 < user2 ? `${user1}_${user2}` : `${user2}_${user1}`;
        }
        
        function getProfileDocRef(userId) {
            return doc(db, `/artifacts/${appId}/users/${userId}/config/profile`);
        }
        
        // ‘≤’•’º’∂’∏÷Ç’¥ ’ß ’ä÷Ä’∏÷Ü’´’¨’´ ’è’æ’µ’°’¨’∂’•÷Ä’®
        async function loadProfile() {
            if (!currentUserId || !db) return;

            const docSnap = await getDoc(getProfileDocRef(currentUserId));
            if (docSnap.exists()) {
                userProfile = { ...userProfile, ...docSnap.data() };
            }
            updateProfileUI();
        }
        
        // ‘π’°÷Ä’¥’°÷Å’∂’∏÷Ç’¥ ’ß ’ä÷Ä’∏÷Ü’´’¨’´ UI-’® (’ç’°’µ’§’¢’°÷Ä ÷á ’Ñ’∏’§’°’¨)
        function updateProfileUI() {
            const avatarSrc = userProfile.avatarUrl || `https://placehold.co/32x32/3B82F6/FFFFFF?text=${userProfile.displayName[0].toUpperCase()}`;
            const displayName = userProfile.displayName || 'Guest';

            sidebarDisplayNameEl.textContent = displayName;
            sidebarAvatarEl.src = avatarSrc;

            // ’Ñ’∏’§’°’¨’´ ’§’°’∑’ø’•÷Ä
            profileUserIdEl.textContent = currentUserId;
            displayNameInput.value = displayName;
            profileAvatarDisplayEl.src = userProfile.avatarUrl || `https://placehold.co/100x100/3B82F6/FFFFFF?text=${displayName[0].toUpperCase()}`;
        }
        
        // ’ä’°’∞’∫’°’∂’∏÷Ç’¥ ’ß ‘∏’∂’Ø’•÷Ä’∂’•÷Ä’´ ’ë’∏÷Ç÷Å’°’Ø’®
        async function saveFriends() {
            if (!currentUserId || !db) return;
            const friendsToSave = userList.filter(id => id !== currentUserId);
            const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/config/friends`);
            try {
                await setDoc(userDocRef, { list: friendsToSave }, { merge: true });
            } catch (e) {
                console.error("Error saving friend list:", e);
            }
        }
        
        // ‘≤’•’º’∂’∏÷Ç’¥ ’ß ‘∏’∂’Ø’•÷Ä’∂’•÷Ä’´ ’ë’∏÷Ç÷Å’°’Ø’®
        async function loadFriends() {
             if (!currentUserId || !db) return;

            const userDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/config/friends`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const savedFriends = docSnap.data().list || [];
                    savedFriends.forEach(friendId => {
                        if (friendId !== currentUserId && !userList.includes(friendId)) {
                            userList.push(friendId);
                        }
                    });
                    renderUsersList();
                }
            } catch (e) {
                console.error("Error loading friend list:", e);
            }
        }

        // ‘≤’•’º’∂’∏÷Ç’¥ ’ß ‘≤’∏’¨’∏÷Ä ’ï’£’ø’°’ø’•÷Ä’•÷Ä’´ ’ä÷Ä’∏÷Ü’´’¨’∂’•÷Ä’®
        async function getRecipientProfile(userId) {
            if (!db) return { displayName: userId.substring(0, 8) + '...', avatarUrl: null };
            
            // ’î’°’∂’´ ’∏÷Ä ’¥’•’∂÷Ñ ’π’•’∂÷Ñ ’Ø’°÷Ä’∏’≤ ’Ø’°÷Ä’§’°’¨ ’∏÷Ç÷Ä’´’∑’´ private config-’®, ’°’µ’Ω ÷Ü’∏÷Ç’∂’Ø÷Å’´’°’∂ ’∫’•’ø÷Ñ ’ß ’¢’°÷Å’°’Ø’°’µ’´ 
            // ’Ø’°’¥ ’∫’•’ø÷Ñ ’ß ÷Ö’£’ø’°’£’∏÷Ä’Æ’´ Public path-’®: ‘±’µ’Ω ’∫’°’∞’´’∂ ÷Ö’£’ø’°’£’∏÷Ä’Æ’∏÷Ç’¥ ’•’∂÷Ñ ’¥’´’°’µ’∂ ID-’∂÷â
            // ‘ª÷Ä’°’Ø’°’∂ app-’∏÷Ç’¥ ’Ø÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’•÷Ä public_profiles/{userId} path-’®
            return { 
                displayName: userId.substring(0, 8) + '...', 
                avatarUrl: `https://placehold.co/32x32/1E40AF/FFFFFF?text=${userId[0].toUpperCase()}`
            }; 
        }

        function renderUsersList() {
            const filteredUsers = userList.filter(id => id !== currentUserId);
            usersListEl.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                 usersListEl.innerHTML = `<li class="p-3 text-sm text-gray-500">‘±’æ’•’¨’°÷Å÷Ä’•÷Ñ ID:</li>`;
                 return;
            }

            filteredUsers.forEach(async userId => {
                const profile = await getRecipientProfile(userId);
                
                const li = document.createElement('li');
                li.id = `user-${userId}`;
                li.className = `user-item flex items-center gap-3 ${activeRecipientId === userId ? 'user-active' : ''}`;
                
                const avatar = `<img src="${profile.avatarUrl}" class="w-8 h-8 rounded-full object-cover border border-[#1C243B]" onerror="this.src='https://placehold.co/32x32/1E40AF/FFFFFF?text=R'">`;
                
                li.innerHTML = `
                    ${avatar}
                    <div class="flex flex-col overflow-hidden flex-grow">
                        <span class="font-semibold text-sm truncate">${profile.displayName}</span>
                        <span class="text-xs text-gray-400">ID: ${userId.substring(0, 8)}...</span>
                    </div>
                `;
                li.onclick = () => selectRecipient(userId);
                usersListEl.appendChild(li);
            });
        }
        
        window.addUser = function() {
            const input = document.getElementById('add-user-input');
            const newUserId = input.value.trim();
            
            if (!newUserId || newUserId.length < 5 || newUserId === currentUserId || userList.includes(newUserId)) {
                alert("’ç’≠’°’¨ ID ’Ø’°’¥ ’°÷Ä’§’•’∂ ÷Å’∏÷Ç÷Å’°’Ø’∏÷Ç’¥ ’ß÷â");
                input.value = '';
                return;
            }
            
            userList.push(newUserId);
            input.value = '';
            renderUsersList();
            saveFriends(); 
            selectRecipient(newUserId); 
        }

        window.selectRecipient = async function(userId) {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            activeRecipientId = userId;
            
            const profile = await getRecipientProfile(userId);
            currentChatNameEl.textContent = profile.displayName;
            
            messageInput.disabled = false;
            sendButton.disabled = false;
            micButton.disabled = false;
            chatContainer.innerHTML = '';
            document.getElementById('initial-message')?.remove();
            
            renderUsersList(); 
            setupChatListener(userId);
            
            // ’á’°÷Ä’™’°’Ø’°’∂ ’ß’Ø÷Ä’°’∂’´ ’∞’°’¥’°÷Ä ÷É’∏’≠’∏÷Ç’¥ ’•’∂÷Ñ ’§’´’ø’∏÷Ç’¥’®
            if (window.innerWidth < 768) {
                toggleView('chat');
            }
        }

        function setupChatListener(recipientId) {
            const chatID = getChatId(currentUserId, recipientId);
            const collectionPath = `/artifacts/${appId}/public/data/chats/${chatID}/messages`;
            const messagesRef = collection(db, collectionPath);
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            let initialLoad = true;

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        
                        if (!initialLoad && message.userId !== currentUserId && message.userId === activeRecipientId) {
                            showNotification(message.userId, message.text, message.type);
                        }
                    }
                });

                chatContainer.innerHTML = '';
                snapshot.docs.forEach((doc) => {
                    const message = doc.data();
                    displayMessage(message);
                });

                initialLoad = false;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, (error) => {
                console.error("Real-time Listener Error:", error);
                currentChatNameEl.textContent = `üö´ ‘ø’°’∫’´ ’ç’≠’°’¨÷â`;
            });
        }

        function displayMessage(message) {
            const isLocal = message.userId === currentUserId;
            const messageElement = document.createElement('div');
            
            const classes = isLocal ? 'message-local ml-auto' : 'message-remote mr-auto';
            const time = message.timestamp && message.timestamp.toDate ? message.timestamp.toDate().toLocaleTimeString('hy-AM', { hour: '2-digit', minute: '2-digit' }) : '';
            
            let content;

            if (message.type === 'audio' && message.audioData) {
                const audioUrl = base64ToAudioUrl(message.audioData, 'audio/webm');
                content = `
                    <div class="flex items-center gap-2 min-w-[200px]">
                        <i class="fas fa-music text-lg ${isLocal ? 'text-blue-200' : 'text-gray-400'}"></i>
                        <audio controls src="${audioUrl}" class="w-full bg-transparent h-8">
                            ’Å’•÷Ä ’¢÷Ä’°’∏÷Ç’¶’•÷Ä’® ’π’´ ’°’ª’°’Ø÷Å’∏÷Ç’¥ ’°’∏÷Ç’§’´’∏’µ’´’∂÷â
                        </audio>
                    </div>
                `;
            } else {
                content = `<p class="text-base break-words">${message.text}</p>`;
            }
            
            messageElement.className = `flex ${isLocal ? 'justify-end' : 'justify-start'} my-2`;
            messageElement.innerHTML = `
                <div class="${classes} max-w-[70%] p-3 text-sm flex flex-col gap-1 rounded-xl">
                    ${content}
                    <span class="text-xs ${isLocal ? 'text-blue-200' : 'text-gray-400'} opacity-80 text-right">${time}</span>
                </div>
            `;
            chatContainer.appendChild(messageElement);
        }

        window.sendMessage = async function(type = 'text', data = null) {
            const messageText = messageInput.value.trim();

            if (type === 'text' && (!messageText || !currentUserId || !activeRecipientId || !db)) return;
            if (type === 'audio' && (!data || !currentUserId || !activeRecipientId || !db)) return;

            const chatID = getChatId(currentUserId, activeRecipientId);
            const collectionPath = `/artifacts/${appId}/public/data/chats/${chatID}/messages`;
            
            const originalIcon = sendButton.innerHTML;
            sendButton.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i>`;
            sendButton.disabled = true;
            messageInput.disabled = true;

            try {
                const messagePayload = {
                    userId: currentUserId,
                    timestamp: serverTimestamp(),
                    type: type,
                };
                
                if (type === 'text') {
                    messagePayload.text = messageText;
                    messageInput.value = ''; 
                } else if (type === 'audio') {
                    messagePayload.audioData = data;
                }

                await addDoc(collection(db, collectionPath), messagePayload);
            } catch (e) {
                console.error("Message Sending Error:", e);
                alert("’Ä’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’® ’π’∞’°’ª’∏’≤’æ’•÷Å ’∏÷Ç’≤’°÷Ä’Ø’•’¨: ’ç’ø’∏÷Ç’£’•÷Ñ ’Ø’°’∫’®:");
            } finally {
                sendButton.innerHTML = originalIcon;
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // --- 2. Profile/Settings Modal Logic ---
        window.openProfileModal = function() {
            updateProfileUI(); // ‘±’¥’•’∂ ’°’∂’£’°’¥ ’¢’°÷Å’•’¨’∏÷Ç÷Å ’©’°÷Ä’¥’°÷Å’∂’∏÷Ç’¥ ’•’∂÷Ñ ’§’°’∑’ø’•÷Ä’®
            profileModalEl.classList.remove('hidden');
        }

        window.closeProfileModal = function() {
            profileModalEl.classList.add('hidden');
        }

        window.saveProfileChanges = async function() {
            const newDisplayName = displayNameInput.value.trim();
            const avatarFile = avatarInput.files[0];
            let avatarBase64 = userProfile.avatarUrl; // ’ä’°’∞’∫’°’∂’∏÷Ç’¥ ’•’∂÷Ñ ’∞’´’∂’®, ’•’©’• ’∂’∏÷Ä’® ’π’´ ’¢’•’º’∂’æ’•’¨

            if (newDisplayName && newDisplayName.length > 0) {
                userProfile.displayName = newDisplayName;
            }

            if (avatarFile) {
                try {
                    avatarBase64 = await fileToBase64(avatarFile);
                    userProfile.avatarUrl = avatarBase64;
                } catch (error) {
                    console.error("Error reading file:", error);
                    alert("’Ü’Ø’°÷Ä’´ ’¢’•’º’∂’¥’°’∂ ’Ω’≠’°’¨÷â");
                    return;
                }
            }
            
            // ’ä’°’∞’∫’°’∂’∏÷Ç’¥ ’•’∂÷Ñ Firestore-’∏÷Ç’¥
            try {
                 await setDoc(getProfileDocRef(currentUserId), userProfile, { merge: true });
                 updateProfileUI();
                 alert("’ä÷Ä’∏÷Ü’´’¨’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’∫’°’∞’∫’°’∂’æ’•÷Å÷â");
            } catch (e) {
                 console.error("Error saving profile:", e);
                 alert("’ä÷Ä’∏÷Ü’´’¨’® ’∫’°’∞’∫’°’∂’•’¨’´’Ω ’Ω’≠’°’¨ ’ø’•’≤’´ ’∏÷Ç’∂’•÷Å’°’æ÷â");
            }

            // ’Ñ’°÷Ñ÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ÷Ü’°’µ’¨’´ ’§’°’∑’ø’®
            avatarInput.value = '';
            closeProfileModal();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // --- 3. Notifications, Media & Utility ---
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                notifStatusEl.textContent = "’â’´ ‘±’ª’°’Ø÷Å’æ’∏÷Ç’¥";
                return;
            }
            
            if (Notification.permission === "granted") {
                notifStatusEl.textContent = "’Ñ’´’°÷Å’æ’°’Æ";
                return;
            }

            Notification.requestPermission().then((permission) => {
                notifStatusEl.textContent = (permission === "granted") ? "’Ñ’´’°÷Å’æ’°’Æ" : "‘±’∂’ª’°’ø’æ’°’Æ";
            });
        }

        function showNotification(senderId, text, type) {
            if (Notification.permission === "granted" && !document.hasFocus()) {
                const title = `ImChat: ’Ü’∏÷Ä ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂`;
                let body = type === 'audio' ? "üéôÔ∏è ’Å’°’µ’∂’°’µ’´’∂ ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂" : text;
                
                new Notification(title, {
                    body: body,
                    icon: userProfile.avatarUrl || "https://placehold.co/100x100/007AFF/ffffff?text=IC",
                });
            }
        }
        
        async function checkMediaPermissions() {
             try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                micButton.disabled = false;
                micButton.classList.remove('bg-gray-600');
                micButton.classList.add('bg-red-600');
                micStatusEl.textContent = "‘π’∏÷Ç’µ’¨’°’ø÷Ä’æ’°’Æ";
            } catch (err) {
                micButton.disabled = true;
                micButton.classList.remove('bg-red-600');
                micButton.classList.add('bg-gray-600');
                micStatusEl.textContent = "‘±÷Ä’£’•’¨’æ’°’Æ";
                micStatusEl.classList.add('text-red-500');
            }
        }

        window.toggleRecording = async function() {
            if (!mediaRecorder) {
                // ’ç’Ø’Ω’•’¨ ’Å’°’µ’∂’°’£÷Ä’∏÷Ç’¥’®
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                    mediaRecorder.onstop = () => {
                        stream.getTracks().forEach(track => track.stop());
                        if (audioChunks.length > 0) {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            audioToBase64(audioBlob).then(base64Data => {
                                sendMessage('audio', base64Data);
                            });
                        }
                    };
                    
                    mediaRecorder.start();
                    startRecordingTimer();
                    
                    // ‘π’°÷Ñ÷Å’∂’•’¨ ’ø’•÷Ñ’Ω’ø’°’µ’´’∂ ’¥’∏÷Ç’ø÷Ñ’®, ÷Å’∏÷Ç÷Å’°’§÷Ä’•’¨ ’±’°’µ’∂’°’£÷Ä’¥’°’∂ ’Ø’°÷Ä’£’°’æ’´’≥’°’Ø’®
                    document.getElementById('message-input').classList.add('hidden');
                    recordingStatusEl.classList.remove('hidden');
                    micButton.innerHTML = `<i class="fas fa-stop"></i>`;

                } catch (err) {
                    alert("’Ñ’´’Ø÷Ä’∏÷Ü’∏’∂’´ ’∞’°’Ω’°’∂’•’¨’´’∏÷Ç’©’µ’°’∂ ’Ω’≠’°’¨÷â");
                }
            } else {
                // ‘±’æ’°÷Ä’ø’•’¨ ’Å’°’µ’∂’°’£÷Ä’∏÷Ç’¥’® (’à÷Ç’≤’°÷Ä’Ø’•’¨)
                stopRecording(true);
            }
        }
        
        function stopRecording(send = true) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder = null;
                clearInterval(recordingTimer);
                recTimeEl.textContent = '0:00';
            }

            if (!send) audioChunks = [];
            
            // ’é’•÷Ä’°’§’°÷Ä’±’∂’•’¨ UI-’®
            micButton.innerHTML = `<i class="fas fa-microphone"></i>`;
            document.getElementById('message-input').classList.remove('hidden');
            recordingStatusEl.classList.add('hidden');
            
            // ‘π’°÷Ä’¥’°÷Å’∂’•’¨ ’£’∏÷Ç’µ’∂’® (’Ø’°÷Ä’¥’´÷Ä’® ’§’∂’•’¨’∏÷Ç ’•’∂÷Ñ ’¥’´’°’µ’∂ ’±’°’µ’∂’°’£÷Ä’¥’°’∂ ’™’°’¥’°’∂’°’Ø)
            micButton.classList.remove('bg-gray-600');
            micButton.classList.add('bg-red-600');
            
        }

        function startRecordingTimer() {
            recordingStartTime = Date.now();
            recordingTimer = setInterval(() => {
                const elapsed = Date.now() - recordingStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                recTimeEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }, 1000);
        }
        
        function audioToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => { resolve(reader.result.split(',')[1]); }; 
                reader.readAsDataURL(blob);
            });
        }

        function base64ToAudioUrl(base64, mimeType) {
            const binary = atob(base64);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            const blob = new Blob([array], { type: mimeType });
            return URL.createObjectURL(blob);
        }
        
        // ’á’°÷Ä’™’°’Ø’°’∂ ’§’´’¶’°’µ’∂’´ ’Ø’°’º’°’æ’°÷Ä’∏÷Ç’¥
        const usersPanel = document.getElementById('users-panel');
        const chatArea = document.getElementById('chat-area-main');
        
        function toggleView(view) {
            if (window.innerWidth >= 768) return; // ’Ñ’´’°’µ’∂ ÷É’∏÷Ñ÷Ä ’ß’Ø÷Ä’°’∂’∂’•÷Ä’´ ’∞’°’¥’°÷Ä

            if (view === 'chat') {
                usersPanel.classList.remove('active');
                usersPanel.classList.add('inactive');
                chatArea.classList.add('active');
                chatArea.classList.remove('inactive');
                chatArea.style.display = 'flex';
                usersPanel.style.display = 'none';
            } else { // 'list'
                usersPanel.classList.add('active');
                usersPanel.classList.remove('inactive');
                chatArea.classList.remove('active');
                chatArea.classList.add('inactive');
                usersPanel.style.display = 'flex';
                chatArea.style.display = 'none';
            }
        }

        // ’ç’Ø’¶’¢’∂’°’Ø’°’∂ ’¢’•’º’∂’∏÷Ç’¥
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                usersPanel.classList.add('active');
                usersPanel.classList.remove('inactive');
                chatArea.classList.add('active');
                chatArea.classList.remove('inactive');
                usersPanel.style.display = 'flex';
                chatArea.style.display = 'flex';
            } else if (activeRecipientId) {
                 toggleView('chat'); // ‘µ’©’• ’π’°’©’® ’¢’°÷Å ’ß, ’¥’∂’∏÷Ç’¥ ’ß ’π’°’©’∏÷Ç’¥
            } else {
                 toggleView('list'); // ‘µ’©’• ’π’°’©’® ’¢’°÷Å ’π’ß, ÷Å’∏÷Ç’µ÷Å ’ß ’ø’°’¨’´’Ω ÷Å’∏÷Ç÷Å’°’Ø’®
            }
        });

        // ‘æ÷Ä’°’£÷Ä’´ ’Ω’Ø’´’¶’¢
        initializeFirebase();

    </script>
</body>
</html>